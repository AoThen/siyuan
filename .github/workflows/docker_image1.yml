name: A Release Docker Image

on:
  workflow_dispatch:
    inputs:
      foc:
        required: false
        type: boolean
        default: false
      docker_tab:
        required: false
        type: string
        default: 'latest'
  # schedule:
  #   - cron: "0 1 */3 * *"

jobs:
  build:
    name: build
    runs-on: ubuntu-latest

    permissions:
      packages: write
      contents: write
      actions: write
      
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.ref }}
          submodules: recursive

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Check out the repo
        uses: actions/checkout@main

      - name: Check version
        id: Check
        run: |

            if [ -f version.latest ]; then
              version1=$(cat version.latest | grep -E 'tag_name\": \"v[0-9]+.[0-9]+.[0-9]+' -o | head -n 1 | tr -d 'tag_name\": \"')
            else
              version1=""
            fi

            echo $version1
            curl -o version.latest https://api.github.com/repos/siyuan-note/siyuan/releases/latest
            version2=$(cat version.latest | grep -E 'tag_name\": \"v[0-9]+.[0-9]+.[0-9]+' -o | head -n 1 | tr -d 'tag_name\": \"')
            echo $version2

            git config --global user.email ${{ secrets.EMAIL }}
            git config --global user.name ${{ secrets.NAME }}

            if [ "$version1" != "$version2" ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              git add version.latest
            fi


      - name: Clone repo
        if: steps.Check.outputs.status == 'success'
        run: |
            git clone --depth 1 https://github.com/siyuan-note/siyuan.git /tmp/siyuan
            cp -f Dockerfile /tmp/siyuan/Dockerfile
            rm -rf /tmp/siyuan/.github/workflows/*
            grep version /tmp/siyuan/app/package.json | awk -F':' '{print $2}' | awk -F',' '{print $1}'
            cp -rf /tmp/siyuan/* ${PWD}
            git add -A
            Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
            git commit -m "$version2 update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"
            git push "https://${{ secrets.NAME }}:${{ github.token }}@github.com/${{ github.repository }}.git" master


# grep version app/package.json | awk -F':' '{print $2}' | awk -F',' '{print $1}'

      - name: Set up QEMU
        if: steps.Check.outputs.status == 'success' || ${{ inputs.foc }}
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker buildx
        if: steps.Check.outputs.status == 'success' || ${{ inputs.foc }}
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.Check.outputs.status == 'success' || ${{ inputs.foc }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PWD }}

      - name: Build the Docker image
        if: steps.Check.outputs.status == 'success' || ${{ inputs.foc }}
        run: |
          echo ${{ inputs.docker_tab }}
          inputValue=${{ inputs.docker_tab || 'latest' }}
          echo "ä½¿ç”¨çš„è¾“å…¥å€¼æ˜¯: $inputValue"
          docker buildx build --push --platform linux/amd64,linux/arm64 -t aothen/siyuan:$inputValue .


      - name: Delete workflow runs
        uses: AoThen/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
